---
# Keycloak Helm Chart Values

# Replica count for Keycloak StatefulSet
replicaCount: 2

image:
  repository: quay.io/keycloak/keycloak
  tag: "26.0.5"
  pullPolicy: IfNotPresent

# MCP Server sidecar configuration
# Provides AI/LLM integration via Model Context Protocol
mcpServer:
  image:
    repository: quay.io/sshaaf/keycloak-mcp-server
    tag: "latest"
    pullPolicy: IfNotPresent
  port: 8081
  # Path where MCP server is exposed (must start with /)
  path: /mcp
  # Basic authentication for MCP endpoint (mandatory)
  auth:
    username: mcp
    password: ""  # Will be auto-generated if empty
  # OIDC client configuration
  # Automatically creates and configures OIDC client for MCP server authentication
  oidcClient:
    enabled: true
    clientId: mcp-server
    name: MCP Server
    description: OIDC client for MCP server authentication
    realm: master
    # OAuth2 flows
    directAccessGrants: true  # Enable password grant (Resource Owner Password Credentials)
    standardFlow: true        # Enable authorization code flow
    serviceAccounts: false    # Disable service accounts
    authorization: false      # Disable authorization services
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# Keycloak admin credentials
admin:
  username: admin
  # Generate a strong password and store in secret
  password: ""  # Will be auto-generated if empty
  existingSecret: ""  # Use existing secret instead

# Database configuration using CNPG
database:
  enabled: true
  # Create Database CRD (set to false if deploying to different namespace)
  createDatabaseCRD: true
  # Database namespace (where CNPG cluster lives)
  namespace: database
  # CNPG cluster name
  clusterName: postgresql
  # Database connection
  host: postgresql-rw.database.svc.cluster.local
  port: 5432
  name: keycloak
  username: keycloak
  password: ""  # Will be auto-generated if empty
  existingSecret: ""  # Use existing secret instead
  # CNPG Cluster configuration (for reference/documentation)
  cnpg:
    instances: 3
    storage:
      size: 10Gi
      storageClass: longhorn
    postgresql:
      parameters:
        max_connections: "200"
        shared_buffers: "256MB"
    backup:
      enabled: false
      # Configuration for backups if needed

# Keycloak configuration
keycloak:
  # Proxy headers mode: xforwarded (for TLS termination at ingress), forwarded
  # Use 'xforwarded' when nginx ingress terminates TLS
  proxyHeaders: xforwarded
  # Cache: ispn (Infinispan) for distributed caching and clustering
  cache: ispn
  # Health check port
  healthPort: 9000
  # Metrics endpoint
  metricsEnabled: true

  # Additional environment variables
  extraEnv: []
  # - name: CUSTOM_VAR
  #   value: "value"

  # Resource requirements
  resources:
    requests:
      cpu: 500m
      memory: 1700Mi
    limits:
      cpu: 2000m
      memory: 2000Mi

  # Liveness probe
  livenessProbe:
    httpGet:
      path: /health/live
      port: 9000
    initialDelaySeconds: 0
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Readiness probe
  readinessProbe:
    httpGet:
      path: /health/ready
      port: 9000
    initialDelaySeconds: 10
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3

  # Startup probe
  startupProbe:
    httpGet:
      path: /health/started
      port: 9000
    initialDelaySeconds: 15
    periodSeconds: 1
    timeoutSeconds: 5
    failureThreshold: 600

# Service configuration
service:
  type: ClusterIP
  port: 8080
  httpsPort: 8443
  # Headless service for StatefulSet discovery
  headless:
    enabled: true

# Ingress configuration
ingress:
  enabled: true
  className: nginx
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/proxy-buffer-size: "128k"
    nginx.ingress.kubernetes.io/proxy-buffers: "4 256k"
    nginx.ingress.kubernetes.io/proxy-busy-buffers-size: "256k"
  hosts:
    - host: keycloak.example.com
      paths:
        - path: /
          pathType: Prefix
  # TLS configuration - auto-generated if cert-manager annotation is present
  tls: []
  # - secretName: keycloak-tls  # Optional - auto-generated if not specified
  #   hosts: []  # Optional - defaults to ingress.hosts if not specified

# Prometheus ServiceMonitor and Alert Rules
monitoring:
  enabled: true
  # ServiceMonitor configuration for Prometheus Operator
  serviceMonitor:
    enabled: true
    interval: 30s
    scrapeTimeout: 10s
    labels: {}
    # Additional labels for ServiceMonitor selector

  # PrometheusRule configuration for alert rules
  prometheusRule:
    enabled: true
    interval: 30s
    labels: {}
    # Additional labels for PrometheusRule selector
    rules:
      highMemoryThreshold: 90  # Percentage
      highErrorRateThreshold: 0.05  # 5% error rate
      slowResponseThreshold: 2  # Seconds
      dbConnectionThreshold: 0.8  # 80% of max connections
      gcFrequencyThreshold: 1  # GC pauses per second

# Pod Security Context
podSecurityContext:
  fsGroup: 1000
  runAsNonRoot: true
  runAsUser: 1000

# Security Context
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL
  readOnlyRootFilesystem: false
  runAsNonRoot: true
  runAsUser: 1000

# Node selector
nodeSelector: {}

# Tolerations
tolerations: []

# Affinity
affinity: {}

# Pod annotations
podAnnotations: {}

# Pod labels
podLabels: {}
